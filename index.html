<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cyber Minimal ‚Äî Final (Polished)</title>
<style>
  /* ===== Base ===== */
  html,body { height:100%; margin:0; padding:0; background:#040405; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; color:#e8f8ff; -webkit-font-smoothing:antialiased; }
  #bgCanvas{ position:fixed; left:0; top:0; width:100%; height:100%; z-index:0; pointer-events:none; opacity:0.12 }
  .container{ position:relative; z-index:2; max-width:980px; margin:12px auto; padding:12px; }
  .topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:12px; flex-wrap:wrap }
  .brand{ font-weight:800; letter-spacing:1px; color:#b99bff; font-size:18px; white-space:nowrap }
  .time{ font-weight:600; font-size:15px; color:#d8faff; white-space:nowrap }

  /* ===== Layout ===== */
  .grid{ display:flex; gap:12px; flex-wrap:wrap }
  .leftCol{ flex:1; min-width:300px }
  .rightCol{ width:340px; min-width:260px }

  /* ===== Card ===== */
  .card { background:linear-gradient(180deg,rgba(255,255,255,0.016),rgba(255,255,255,0.01)); border-radius:14px; padding:12px; box-shadow:0 18px 45px rgba(0,0,0,0.55), 0 6px 20px rgba(155,92,255,0.08); border:1px solid rgba(155,92,255,0.06); margin-bottom:12px; overflow:hidden; }
  .card.small { padding:10px }
  h1 { margin:0; font-size:15px; color:#d4c9ff; line-height:1.1; }
  .muted { font-size:12px; color:#7d9aa8; margin-top:6px; }

  /* ===== Markets ===== */
  .crypto-row{ display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px dashed rgba(155,92,255,0.04) }
  .crypto-row:last-child{ border-bottom:0 }
  .ticker { font-family:monospace; font-weight:700; color:#e6fff7 }
  .price { font-family:monospace; color:#e6ffd9; min-width:120px; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .spark-wrap { display:flex; align-items:center; gap:8px; min-width:120px; justify-content:flex-end }
  svg.spark { width:120px; height:36px; border-radius:6px; }

  /* ===== Quote ===== */
  .quote { font-size:15px; padding:10px; border-radius:8px; background:linear-gradient(180deg,rgba(155,92,255,0.02),transparent); border:1px solid rgba(155,92,255,0.03); color:#cfeffb; min-height:42px; box-sizing:border-box; word-break:break-word; }

  /* ===== Todo ===== */
  .todo-list{ margin-top:8px; max-height:220px; overflow:auto; }
  .todo-item{ display:flex; align-items:center; padding:8px; border-radius:8px; margin-bottom:6px; background:linear-gradient(180deg,rgba(0,0,0,0.06),transparent) }
  .todo-item input[type=text]{ flex:1; border:0; background:transparent; color:inherit; padding:6px; font-size:14px; outline:none; min-width:50px; word-break:break-word }
  .todo-item button{ background:none; border:0; color:#ff9b9b; padding:6px; font-size:14px; white-space:nowrap }

  /* ===== Habit rings ===== */
  .rings{ display:flex; gap:12px; align-items:center; justify-content:flex-start; flex-wrap:wrap; margin-top:8px }
  .ring-wrap{ width:92px; height:110px; text-align:center; flex:0 0 92px; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; justify-content:flex-start }
  canvas.ring{ width:92px; height:92px; border-radius:10px; background:transparent }
  .ring-label{ margin-top:6px; font-size:12px; color:#d4c0ff; text-align:center; white-space:normal; word-break:break-word; max-width:92px }

  /* ===== Quick actions ===== */
  .quick-grid{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .quick-btn{ background:linear-gradient(180deg,#9b5cff,#7f43ff); border:0; padding:8px 10px; border-radius:10px; color:#000; font-weight:700; min-width:78px; text-align:center }

  /* ===== Pomodoro ===== */
  .pom-time{ font-size:30px; font-weight:800; color:#e9d8ff; text-align:center; margin-top:8px }
  .pom-controls{ display:flex; gap:8px; justify-content:center; margin-top:10px }

  /* ===== Weather ===== */
  .weather-line{ display:flex; align-items:center; justify-content:space-between }
  .weather-left{ display:flex; align-items:center; gap:10px }
  .weather-icon{ width:44px; height:44px; border-radius:8px; background:rgba(255,255,255,0.02); display:flex; align-items:center; justify-content:center; font-size:20px }
  .temp{ font-size:20px; color:#d8c8ff; font-weight:700; }

  /* ===== Settings ===== */
  .tiny{ font-size:11px; color:#5a7a86; margin-top:8px }

  /* ===== Misc ===== */
  .glow { box-shadow:0 10px 30px rgba(155,92,255,0.08) }
  .elev { box-shadow:0 22px 50px rgba(0,0,0,0.6), 0 6px 24px rgba(155,92,255,0.10) }

  /* ===== Responsive ===== */
  @media(max-width:860px){ .grid{ flex-direction:column } .rightCol{ width:100% } .ring-wrap{ margin-right:6px } }
</style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="container" id="app">
  <div class="topbar">
    <div class="brand">CYBER DASH</div>
    <div class="time" id="time">--:--</div>
  </div>

  <div class="grid">
    <div class="leftCol">
      <!-- Markets -->
      <div class="card elev" id="marketsCard">
        <h1>MARKETS</h1>
        <div class="muted">prices ¬∑ 24h sparklines</div>
        <div id="cryptoRows" style="margin-top:10px; max-height:260px; overflow:auto;"></div>
        <div class="tiny">Source: Coinlore (prices) ¬∑ CoinGecko (historic data)</div>
      </div>

      <!-- Quote & Todo -->
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <div style="flex:1;min-width:260px" class="card glow small">
          <h1>QUOTE</h1>
          <div class="quote" id="quote">Loading...</div>
          <div class="tiny">Tap to change (offline fallback available).</div>
        </div>

        <div style="flex:1;min-width:260px" class="card glow small">
          <h1>TO-DO</h1>
          <div class="todo-list" id="todoList"></div>
          <div class="controls">
            <input id="newTodo" class="small" type="text" placeholder="Add task and press Enter">
            <button id="addTodo" class="quick-btn">Add</button>
            <button id="clearDone" class="quick-btn">Clear</button>
          </div>
          <div class="tiny">Tap text to edit ‚Äî keyboard should stay.</div>
        </div>
      </div>

      <!-- Pomodoro -->
      <div class="card elev">
        <h1>POMODORO ‚Äî Focus (25 min)</h1>
        <div class="pom-time" id="pomTime">25:00</div>
        <div class="pom-controls">
          <button id="pomStart" class="quick-btn">Start</button>
          <button id="pomPause" class="quick-btn">Pause</button>
          <button id="pomReset" class="quick-btn">Reset</button>
        </div>
        <div class="tiny">When finished ‚Äî alert will show.</div>
      </div>
    </div>

    <div class="rightCol">
      <div class="card elev">
        <h1>HABIT RINGS</h1>
        <div class="muted">Tap ring to mark today's completion</div>
        <div class="rings" id="ringsContainer" style="margin-top:10px;"></div>
        <div class="tiny">Habits: Meditate ¬∑ Read ¬∑ Move ‚Äî single tap marks complete (100%).</div>
      </div>

      <div class="card glow small">
        <h1>VITAMINS</h1>
        <div id="vitList" style="margin-top:8px; max-height:180px; overflow:auto;"></div>
        <div class="controls" style="margin-top:8px;">
          <input id="newVit" class="small" type="text" placeholder="Add vitamin">
          <button id="addVit" class="quick-btn">Add</button>
        </div>
        <div class="tiny">Quick check for pills.</div>
      </div>

      <div class="card elev">
        <h1>QUICK ACTIONS</h1>
        <div class="muted">Track tiny wins (stored locally)</div>
        <div class="quick-grid" id="quickGrid"></div>
        <div class="tiny" style="margin-top:8px">Water ¬∑ Walk ¬∑ Meditate</div>
      </div>

      <div class="card glow small">
        <h1>WEATHER ‚Äî Kharkiv</h1>
        <div class="weather-line">
          <div class="weather-left">
            <div class="weather-icon" id="wIcon">‚òÅ</div>
            <div>
              <div id="wCond" class="muted">Loading...</div>
              <div class="temp" id="wTemp">--¬∞C</div>
            </div>
          </div>
          <div>
            <div class="muted">Wind</div>
            <div id="wWind" class="muted">-- km/h</div>
          </div>
        </div>
        <div class="tiny" style="margin-top:8px">Data: Open-Meteo</div>
      </div>

      <div class="card">
        <h1>SETTINGS</h1>
        <div class="muted">Update intervals & screen options</div>
        <div style="margin-top:8px;">
          <div style="display:flex;gap:8px;margin-top:6px;">
            <button class="quick-btn" id="int5">5s</button>
            <button class="quick-btn" id="int15">15s</button>
            <button class="quick-btn" id="int30">30s</button>
            <button class="quick-btn" id="int0">Stop</button>
          </div>
          <div style="margin-top:8px;">
            <button id="reloadAll" class="quick-btn">Reload now</button>
          </div>
          <div style="margin-top:8px;">
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="guardToggle"> Enable 24/7 screen guard</label>
          </div>
        </div>
        <div class="tiny" style="margin-top:8px">Tip: Set iPad Auto-Lock = Never and add to Home Screen.</div>
      </div>

    </div>
  </div>
</div>

<script>
/* Final polished JS ‚Äî ES5 + XHR to be iOS10-friendly */

(function(){

/* ---------- helpers ---------- */
function $(id){ return document.getElementById(id); }
function lsGet(k){ try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch(e){return null;} }
function lsSet(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
function nowISO(){ return (new Date()).toISOString(); }

/* ---------- clock ---------- */
function updateClock(){ var d=new Date(); var hh=d.getHours(); if(hh<10) hh='0'+hh; var mm=d.getMinutes(); if(mm<10) mm='0'+mm; $('time').textContent = hh+':'+mm; }
setInterval(updateClock,1000); updateClock();

/* ---------- particle bg (subtle) ---------- */
var bg = $('bgCanvas'); var ctx = bg.getContext && bg.getContext('2d');
function resizeBg(){ if(!ctx) return; bg.width = window.innerWidth; bg.height = window.innerHeight; }
window.addEventListener('resize', resizeBg); resizeBg();
var particles=[]; for(var i=0;i<60;i++){ particles.push({x:Math.random()*window.innerWidth, y:Math.random()*window.innerHeight, vx:(Math.random()-0.5)*0.25, vy:(Math.random()-0.5)*0.25, r:1+Math.random()*2}); }
function drawBg(){ if(!ctx) return; ctx.clearRect(0,0,bg.width,bg.height); for(var i=0;i<particles.length;i++){ var p=particles[i]; p.x+=p.vx; p.y+=p.vy; if(p.x<0) p.x=bg.width; if(p.x>bg.width) p.x=0; if(p.y<0) p.y=bg.height; if(p.y>bg.height) p.y=0; ctx.beginPath(); ctx.fillStyle='rgba(155,92,255,0.9)'; ctx.globalAlpha = 0.08+Math.random()*0.05; ctx.arc(p.x,p.y,p.r,0,Math.PI*2,false); ctx.fill(); } ctx.globalAlpha=1; requestAnimationFrame(drawBg); }
requestAnimationFrame(drawBg);

/* ---------- markets & sparkline via CoinGecko API (fallback safe) ---------- */
var marketInterval = 15000; var marketTimer = null;
var coins = [
  {id:'bitcoin', sym:'BTC', coingeckoId:'bitcoin', coinloreName:'Bitcoin'},
  {id:'ethereum', sym:'ETH', coingeckoId:'ethereum', coinloreName:'Ethereum'},
  {id:'solana', sym:'SOL', coingeckoId:'solana', coinloreName:'Solana'}
];

function createMarketRows(){
  var container = $('cryptoRows');
  container.innerHTML = '';
  for(var i=0;i<coins.length;i++){
    var c = coins[i];
    var row = document.createElement('div'); row.className='crypto-row';
    var left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
    var tick = document.createElement('div'); tick.className='ticker'; tick.textContent = c.sym;
    var lab = document.createElement('div'); lab.className='muted'; lab.textContent = c.coinloreName;
    left.appendChild(tick); left.appendChild(lab);
    var right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
    var price = document.createElement('div'); price.className='price'; price.id = 'price_'+c.sym; price.textContent = '‚Äî';
    var sparkWrap = document.createElement('div'); sparkWrap.className='spark-wrap';
    var svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('class','spark'); svg.setAttribute('id','spark_'+c.sym); svg.setAttribute('viewBox','0 0 120 36'); svg.setAttribute('preserveAspectRatio','none');
    sparkWrap.appendChild(svg);
    right.appendChild(price); right.appendChild(sparkWrap);
    row.appendChild(left); row.appendChild(right);
    container.appendChild(row);
  }
}
createMarketRows();

/* Load current prices from Coinlore (simple) */
function loadPrices(){
  var xhr = new XMLHttpRequest();
  xhr.open('GET','https://api.coinlore.net/api/tickers/?start=0&limit=10');
  xhr.timeout = 8000;
  xhr.onload = function(){
    if(xhr.status === 200){
      try{
        var resp = JSON.parse(xhr.responseText);
        var list = resp.data || [];
        for(var i=0;i<coins.length;i++){
          var c = coins[i];
          var found = null;
          for(var j=0;j<list.length;j++){ if(list[j].name === c.coinloreName){ found = list[j]; break; } }
          var el = $('price_'+c.sym);
          if(found && el){ el.textContent = '$' + parseFloat(found.price_usd).toFixed(2) + ' (' + found.percent_change_24h + '%)'; }
          else if(el){ el.textContent = '‚Äî'; }
        }
      }catch(e){ console.log('price parse err',e); }
    }
  };
  xhr.ontimeout = function(){ console.log('price timeout'); };
  xhr.onerror = function(){ console.log('price error'); };
  try{ xhr.send(); }catch(e){}
}

/* Build sparkline SVG from CoinGecko market_chart (24h hourly) */
function loadSparklines(){
  for(var i=0;i<coins.length;i++){
    (function(co){
      var xhr = new XMLHttpRequest();
      // get prices for last 1 day (hourly)
      xhr.open('GET','https://api.coingecko.com/api/v3/coins/'+co.coingeckoId+'/market_chart?vs_currency=usd&days=1&interval=hourly');
      xhr.timeout = 9000;
      xhr.onload = function(){
        var svgEl = document.getElementById('spark_'+co.sym);
        if(xhr.status === 200 && svgEl){
          try{
            var data = JSON.parse(xhr.responseText);
            var prices = (data.prices || []).map(function(p){ return p[1]; });
            if(prices.length < 2){ // fallback to text
              svgEl.innerHTML = '<text x="10" y="20" fill="#9b5cff">no data</text>'; return;
            }
            // normalize points into viewBox 0..120 x 0..36
            var w = 120, h = 36;
            var min = Math.min.apply(null, prices), max = Math.max.apply(null, prices);
            var span = max - min || 1;
            var step = w / (prices.length - 1);
            var path = '';
            for(var idx=0; idx<prices.length; idx++){
              var x = idx * step;
              var y = h - ((prices[idx] - min) / span) * (h - 4) - 2; // padding 2
              path += (idx===0?('M ' + x + ' ' + y):(' L ' + x + ' ' + y));
            }
            // create simple filled path (subtle)
            var fillPath = path + ' L ' + w + ' ' + (h) + ' L 0 ' + (h) + ' Z';
            // stroke path
            var stroke = '<path d=\"' + path + '\" stroke=\"#b99bff\" stroke-width=\"1.6\" fill=\"none\" stroke-linecap=\"round\" stroke-linejoin=\"round\" />';
            var fill = '<path d=\"' + fillPath + '\" fill=\"rgba(155,92,255,0.06)\" stroke=\"none\" />';
            svgEl.innerHTML = fill + stroke;
          }catch(e){ svgEl.innerHTML = '<text x="10" y="20" fill="#9b5cff">err</text>'; console.log('spark parse err',e); }
        } else if(svgEl){
          svgEl.innerHTML = '<text x="10" y="20" fill="#9b5cff">no data</text>';
        }
      };
      xhr.ontimeout = function(){ var svgEl = document.getElementById('spark_'+co.sym); if(svgEl) svgEl.innerHTML = '<text x=\"10\" y=\"20\" fill=\"#9b5cff\">timeout</text>'; };
      xhr.onerror = function(){ var svgEl = document.getElementById('spark_'+co.sym); if(svgEl) svgEl.innerHTML = '<text x=\"10\" y=\"20\" fill=\"#9b5cff\">err</text>'; };
      try{ xhr.send(); }catch(e){ var svgEl = document.getElementById('spark_'+co.sym); if(svgEl) svgEl.innerHTML = '<text x=\"10\" y=\"20\" fill=\"#9b5cff\">err</text>'; }
    })(coins[i]);
  }
}

/* ---------- quote ---------- */
var localQuotes = ['–î–µ–π—Å—Ç–≤–∏–µ ‚Äî –º–æ—Å—Ç –º–µ–∂–¥—É –º–µ—á—Ç–æ–π –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.','–ú–∞–ª–µ–Ω—å–∫–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –±–æ–ª—å—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º.','–ù–µ –∂–¥–∏ ‚Äî —Å–æ–∑–¥–∞–≤–∞–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.','–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏.','–û—à–∏–±–∫–∏ ‚Äî —ç—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –Ω–µ –ø—Ä–∏–≥–æ–≤–æ—Ä.'];
function loadQuote(){
  var xhr = new XMLHttpRequest();
  xhr.open('GET','https://api.quotable.io/random');
  xhr.timeout = 5000;
  xhr.onload = function(){
    if(xhr.status === 200){
      try{ var q = JSON.parse(xhr.responseText); $('quote').textContent = q.content; } catch(e){ $('quote').textContent = localQuotes[Math.floor(Math.random()*localQuotes.length)]; }
    } else { $('quote').textContent = localQuotes[Math.floor(Math.random()*localQuotes.length)]; }
  };
  xhr.ontimeout = function(){ $('quote').textContent = localQuotes[Math.floor(Math.random()*localQuotes.length)]; };
  xhr.onerror = function(){ $('quote').textContent = localQuotes[Math.floor(Math.random()*localQuotes.length)]; };
  try{ xhr.send(); }catch(e){ $('quote').textContent = localQuotes[Math.floor(Math.random()*localQuotes.length)]; }
}
document.addEventListener('click', function(e){ if(e.target && e.target.id==='quote') loadQuote(); }, false);

/* ---------- todos (stable editing) ---------- */
var todos = lsGet('cyber_todos') || [];
function saveTodos(){ lsSet('cyber_todos', todos); }
function makeTodoEl(item){
  var wrap = document.createElement('div'); wrap.className='todo-item'; wrap.setAttribute('data-id', item.id);
  var cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!item.done;
  cb.onchange = (function(it){ return function(){ it.done = this.checked; saveTodos(); }; })(item);
  var txt = document.createElement('input'); txt.type='text'; txt.value = item.text;
  txt.oninput = (function(it){ return function(){ it.text = this.value; saveTodos(); }; })(item);
  txt.onfocus = function(){ /* keep keyboard active on old Safari */ };
  var del = document.createElement('button'); del.textContent='‚úï';
  del.onclick = (function(id){ return function(){ removeTodo(id); }; })(item.id);
  wrap.appendChild(cb); wrap.appendChild(txt); wrap.appendChild(del);
  return wrap;
}
function renderTodos(){ var container=$('todoList'); container.innerHTML=''; for(var i=0;i<todos.length;i++) container.appendChild(makeTodoEl(todos[i])); }
function addTodoText(t){ var id='td'+(new Date()).getTime(); todos.unshift({id:id,text:t,done:false}); saveTodos(); renderTodos(); }
function removeTodo(id){ for(var i=0;i<todos.length;i++){ if(todos[i].id===id){ todos.splice(i,1); break; } } saveTodos(); renderTodos(); }
$('addTodo').addEventListener('click', function(){ var v=$('newTodo').value.replace(/^\s+|\s+$/g,''); if(v){ addTodoText(v); $('newTodo').value=''; } }, false);
$('newTodo').addEventListener('keypress', function(e){ if(e.key === 'Enter' || e.keyCode === 13){ $('addTodo').click(); } }, false);
$('clearDone').addEventListener('click', function(){ var left=[]; for(var i=0;i<todos.length;i++){ if(!todos[i].done) left.push(todos[i]); } todos=left; saveTodos(); renderTodos(); }, false);

/* ---------- vitamins ---------- */
var vits = lsGet('cyber_vits') || [{id:'v1',name:'Vitamin D',on:false},{id:'v2',name:'Magnesium',on:false}];
function renderVits(){ var box=$('vitList'); box.innerHTML=''; for(var i=0;i<vits.length;i++){ (function(it,idx){ var wr=document.createElement('div'); wr.className='vit-item'; var left=document.createElement('label'); var cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!it.on; cb.onchange = function(){ vits[idx].on = this.checked; lsSet('cyber_vits', vits); }; var span = document.createElement('div'); span.style.marginLeft='8px'; span.textContent = it.name; left.appendChild(cb); left.appendChild(span); var del = document.createElement('button'); del.textContent='‚úï'; del.onclick = function(){ removeVit(it.id); }; wr.appendChild(left); wr.appendChild(del); box.appendChild(wr); })(vits[i], i); } }
function addVit(name){ if(!name) return; var id='vit'+(new Date()).getTime(); vits.push({id:id,name:name,on:false}); lsSet('cyber_vits', vits); renderVits(); }
function removeVit(id){ for(var i=0;i<vits.length;i++){ if(vits[i].id===id){ vits.splice(i,1); break; } } lsSet('cyber_vits', vits); renderVits(); }
$('addVit').addEventListener('click', function(){ var v=$('newVit').value.replace(/^\s+|\s+$/g,''); if(v){ addVit(v); $('newVit').value=''; } }, false);
$('newVit').addEventListener('keypress', function(e){ if(e.key === 'Enter' || e.keyCode === 13){ $('addVit').click(); } }, false);

/* ---------- habit rings (instant fill to 100%) ---------- */
var habits = lsGet('cyber_habits') || [
  {id:'h1', name:'Meditate', val:0, color:'#b78bff'},
  {id:'h2', name:'Read', val:0, color:'#9b5cff'},
  {id:'h3', name:'Move', val:0, color:'#b78bff'}
];
function drawInstantRing(canvas, fraction, color){
  try{
    var ctx = canvas.getContext('2d');
    var w = canvas.width, h = canvas.height;
    var cx = w/2, cy = h/2, r = Math.min(w,h)/2 - 8;
    ctx.clearRect(0,0,w,h);
    // background
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2,false); ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth = 8; ctx.stroke();
    // progress (instant)
    var start = -Math.PI/2; var end = start + (Math.PI*2) * fraction;
    ctx.beginPath(); ctx.arc(cx,cy,r,start,end,false); ctx.strokeStyle = color; ctx.lineWidth = 8; ctx.lineCap='round'; ctx.stroke();
    // text
    ctx.fillStyle = '#e6eef6'; ctx.font = '12px monospace'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(Math.round(fraction*100)+'%', cx, cy);
  }catch(e){ console.log('draw err', e); }
}

function renderRings(){
  var container = $('ringsContainer'); container.innerHTML = '';
  for(var i=0;i<habits.length;i++){
    (function(it, idx){
      var wrap = document.createElement('div'); wrap.className='ring-wrap';
      var cnv = document.createElement('canvas'); cnv.className='ring'; cnv.width = 92; cnv.height = 92; cnv.style.cursor='pointer';
      cnv.onclick = function(){ toggleHabit(it.id); };
      wrap.appendChild(cnv);
      var lbl = document.createElement('div'); lbl.className='ring-label'; lbl.textContent = it.name;
      wrap.appendChild(lbl);
      container.appendChild(wrap);
      // instant fill: 1 for completed, 0 otherwise
      drawInstantRing(cnv, it.val ? 1 : 0, it.color);
    })(habits[i], i);
  }
}

function toggleHabit(id){
  for(var i=0;i<habits.length;i++){
    if(habits[i].id === id){ habits[i].val = habits[i].val ? 0 : 1; break; }
  }
  lsSet('cyber_habits', habits);
  renderRings();
}

/* ---------- quick actions ---------- */
var quick = lsGet('cyber_quick') || {water:0,walk:0,med:0};
function renderQuick(){
  var box = $('quickGrid'); box.innerHTML = '';
  var keys = [{k:'water',t:'Water'},{k:'walk',t:'Walk'},{k:'med',t:'Meditate'}];
  for(var i=0;i<keys.length;i++){
    (function(k){ var btn = document.createElement('button'); btn.className='quick-btn'; btn.textContent = k.t + ' (' + (quick[k.k]||0) + ')'; btn.onclick = function(){ quick[k.k] = (quick[k.k]||0) + 1; lsSet('cyber_quick', quick); renderQuick(); }; box.appendChild(btn); })(keys[i]);
  }
}
function resetQuick(){ quick = {water:0,walk:0,med:0}; lsSet('cyber_quick', quick); renderQuick(); }

/* ---------- pomodoro ---------- */
var pom = lsGet('cyber_pom') || {total:1500, remaining:1500, running:false};
var pomTimer = null;
function formatTime(s){ var mm=Math.floor(s/60), ss=s%60; if(mm<10) mm='0'+mm; if(ss<10) ss='0'+ss; return mm+':'+ss; }
function updatePomDisplay(){ $('pomTime').textContent = formatTime(pom.remaining); lsSet('cyber_pom', pom); }
function pomStart(){ if(pom.running) return; pom.running=true; pomTimer = setInterval(function(){ if(pom.remaining>0){ pom.remaining--; updatePomDisplay(); } else { pomPause(); try{ window.alert('Pomodoro complete!'); }catch(e){} } },1000); lsSet('cyber_pom', pom); }
function pomPause(){ pom.running=false; if(pomTimer) clearInterval(pomTimer); pomTimer=null; lsSet('cyber_pom', pom); }
function pomReset(){ pomPause(); pom.remaining = pom.total; updatePomDisplay(); lsSet('cyber_pom', pom); }
$('pomStart').addEventListener('click', pomStart, false);
$('pomPause').addEventListener('click', pomPause, false);
$('pomReset').addEventListener('click', pomReset, false);

/* ---------- weather (Kharkiv) ---------- */
function loadWeather(){
  var xhr = new XMLHttpRequest();
  xhr.open('GET','https://api.open-meteo.com/v1/forecast?latitude=50.0&longitude=36.2&current_weather=true');
  xhr.timeout = 7000;
  xhr.onload = function(){
    if(xhr.status === 200){
      try{
        var d = JSON.parse(xhr.responseText);
        var w = d.current_weather || {};
        $('wTemp').textContent = (typeof w.temperature !== 'undefined' ? w.temperature + '¬∞C' : '--¬∞C');
        $('wCond').textContent = 'Current';
        $('wWind').textContent = (typeof w.windspeed !== 'undefined' ? w.windspeed + ' km/h' : '-- km/h');
        var icon = '‚òÅ';
        if(w.weathercode !== undefined){
          var code = w.weathercode;
          if(code >= 80) icon='‚òî'; else if(code>=60) icon='‚õÖ'; else if(code>=20) icon='üå§'; else icon='‚òÄ';
        }
        $('wIcon').textContent = icon;
      }catch(e){ console.log('weather parse',e); }
    }
  };
  xhr.ontimeout = function(){ console.log('weather timeout'); };
  xhr.onerror = function(){ console.log('weather error'); };
  try{ xhr.send(); }catch(e){}
}

/* ---------- settings & intervals ---------- */
$('int5').addEventListener('click', function(){ marketInterval = 5000; startMarketUpdates(); }, false);
$('int15').addEventListener('click', function(){ marketInterval = 15000; startMarketUpdates(); }, false);
$('int30').addEventListener('click', function(){ marketInterval = 30000; startMarketUpdates(); }, false);
$('int0').addEventListener('click', function(){ marketInterval = 0; if(marketTimer) clearInterval(marketTimer); marketTimer=null; }, false);
$('reloadAll').addEventListener('click', function(){ loadPrices(); loadSparklines(); loadQuote(); loadWeather(); }, false);

/* ---------- 24/7 screen guard toggle ---------- */
$('guardToggle').addEventListener('change', function(){ var enabled=this.checked; lsSet('screen_guard', enabled?true:false); var app=document.getElementById('app'); if(enabled){ app.className = app.className + ' screen-guard-active'; } else { app.className = app.className.replace(' screen-guard-active',''); } });
(function(){ var st = lsGet('screen_guard'); if(st){ $('guardToggle').checked = true; document.getElementById('app').className += ' screen-guard-active'; } })();

/* ---------- market scheduler ---------- */
function startMarketUpdates(){ if(marketTimer) clearInterval(marketTimer); if(marketInterval>0) marketTimer = setInterval(function(){ loadPrices(); loadSparklines(); }, marketInterval); }

/* ---------- init ---------- */
function init(){
  // persisted state
  todos = lsGet('cyber_todos') || todos;
  vits = lsGet('cyber_vits') || vits;
  habits = lsGet('cyber_habits') || habits;
  quick = lsGet('cyber_quick') || quick;
  pom = lsGet('cyber_pom') || pom;
  // render
  renderTodos();
  renderVits();
  renderRings();
  renderQuick();
  updatePomDisplay();
  // markets
  loadPrices();
  loadSparklines();
  startMarketUpdates();
  // quote & weather
  loadQuote();
  loadWeather();
  setInterval(loadQuote, 60000);
  setInterval(loadWeather, 60000);
}
init();

})(); /* end IIFE */
</script>

</body>
</html>
